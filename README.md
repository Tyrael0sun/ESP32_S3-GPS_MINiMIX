# ESP32-S3 多功能 GPS 性能分析设备

## 项目概述
本项目基于 **ESP32-S3FH4R2** 微控制器，自研了一套集自行车码表、GPS 轨迹记录和汽车性能测试盒（P-Box）于一体的多功能固件。系统围绕 FreeRTOS 与 LVGL 图形框架构建，完成全部硬件驱动、传感器融合、数据存储与诊断日志功能，面向骑行与驾驶爱好者提供可扩展、精准的实时性能分析工具。

- **固件版本**：V0.0.1（release 中提供合并烧录包）
- **开发环境**：ESP-IDF v6.1
- **芯片资源**：ESP32-S3FH4R2（4 MB Flash / 2 MB PSRAM）

---

## 核心功能
| 模块 | 功能摘要 |
| --- | --- |
| 自行车码表 | 实时速度、海拔、累计里程、骑行时间与录制按钮状态（绿色圆圈/红色闪烁方块）。 |
| GPS 轨迹记录仪 | 轨迹可视化、速度/海拔/里程/时间显示，GPX `<time>` 与 `<extensions>` 同步 RTC/GNSS 时间、电池、电源、模式、P-Box 状态、温度/G 值。 |
| 汽车 P-Box | 0-100 km/h（区间可调）性能测试，IMU+GPS 融合自动启停计时。 |
| GNSS 信息诊断 | 显示定位信息、HDOP/VDOP/PDOP、卫星列表（编号、星座、CN0、状态、滚动）。 |
| 设置与校准 | GNSS 刷新率/动态模式/星座组合，IMU/磁力计运行时校准（UI 引导 + 进度），P-Box 阈值、显示亮度、关于信息。 |
| 日志与诊断 | 启动 5 s 高频自检、低频心跳、按键/旋转事件上报、GNSS ACK/NACK 解析。 |

---

## 硬件与接口
### 关键器件
- **GNSS**：MAX-F10S 或 ATGM336H，UART1@115200 bps（上电默认 9600，使用 PMTK251 切换）。
- **IMU**：LSM6DSR（Z 轴反向，Y 轴不变）（I²C 地址 0x6A）。
- **磁力计**：LIS2MDL（X 轴正常，Y 轴交换且反向，Z 轴反向）（I²C 地址 0x1E）。
- **气压计**：BMP388（I²C 地址 0x76）。
- **显示屏**：ST7789 240×320，竖屏、旋转 180°，SPI3 + DMA 双缓冲。
- **存储**：SD 卡 4-bit SDIO，GPX 文件保存于 `/GPX/`。

### GPIO 配置表
| 功能 | GPIO | 备注 |
| --- | --- | --- |
| DEBUG_TX / DEBUG_RX | 43 / 44 | UART0@115200 bps |
| DISP_SCK / MOSI / CS / DC / RST / BL | 5 / 8 / 7 / 6 / 4 / 9 | SPI3，BL 2 kHz PWM 默认 50% |
| GNSS_TX / GNSS_RX / GPS_LDO_EN | 17 / 18 / 14 | UART1，LDO 高电平使能 |
| I2C_SCL / I2C_SDA | 39 / 40 | I2C0@1 MHz |
| ACCGYRO_INT / MAG_INT / PRESS_INT | 41 / 42 / 13 | 当前未使用 |
| SD_D0~D3 / CMD / CLK / D1 | 37-34 / 35 / 36 / 38 | 4-bit SDIO |
| ENC_A / ENC_B / KEY_MAIN | 1 / 3 / 2 | 旋转编码器 A/B，上拉；主按键上拉 |
| BAT_ADC / CHRG_STATUS | 12 / 21 | 电池电压 1:1 分压；充电状态输入 |

---

## 软件架构
- **操作系统**：FreeRTOS（ESP-IDF v6.1），所有硬件驱动、UI 与业务逻辑高度模块化，统一通过 `config.h` 与 `ui_common.h` 管理。
- **UI 框架**：LVGL v8.3 + ESP LCD API，240×320 竖屏布局详见 `docs/UI_LAYOUT_240x320.md`。
- **输入系统**：旋转编码器 + 主按键，支持短按/中按/长按/双击。按键消抖 50 ms，中按约 500 ms，长按约 2000 ms。编码器采用 ±3 step 滤波，并在 500 ms 无变化时自动清零。
- **数据存储**：GPX 轨迹以 `/GPX/ACT_xxxx.gpx` 命名，写入 `<time>` 与包含温度、G 值、电池、电压、运行模式、P-Box 上下文等 `<extensions>` 字段，便于后处理。
- **校准数据**：IMU 与磁力计运行时校准由后台任务采样，结果写入独立 NVS 命名空间，重启自动加载。

---

## 模式与交互
### 模式切换
旋转编码器依次切换：`自行车码表 → GPS 记录 → P-Box → GNSS 信息 → 设置 → …`，循环切换。
- **短按**：确认/执行。
- **中按（~500 ms）**：开始/停止轨迹记录。
- **长按（~2000 ms）**：进入/退出设置界面。

### 自行车码表（MODE_BIKE_COMPUTER）
- 48 px 速度显示。
- 海拔/累计里程/骑行时间每 45 px 分区显示。
- 记录按钮：未记录显示绿色圆圈，记录中显示红色闪烁方块。

### GPS 轨迹记录器（MODE_GPS_LOGGER）
- 当前速度（100 px）、轨迹图（120 px）、距离（40 px）、时间（40 px）。
- 长按控制录制，状态栏显示 GPS/SD/电池信息。

### P-Box 性能测试（MODE_PBOX）
- 64 px 速度、32 px 计时、目标区间与状态提示。
- 自动启动条件：GPS 速度 <1 km/h 且纵向线性加速度 >0.15 G（阈值在 `config.h` 或设置菜单可调）。
- 测试完成显示 “TEST FINISHED!!!”。

### GNSS 信息界面（MODE_GNSS_INFO）
- 显示经纬度、海拔、速度；HDOP/VDOP/PDOP。
- 卫星列表包含 ID、星座（GPS/GLONASS/Galileo/BeiDou）、CN0、状态，支持滚动；状态颜色：搜索=灰、跟踪=黄、使用=绿。

### 设置菜单（MODE_SETTINGS）
- 菜单项示例：IMU 校准、磁力计校准、GNSS 刷新率（1/5/10/25 Hz）、GNSS 动态模式（步行/汽车/海上/航空）、星座组合、P-Box 阈值、显示亮度、关于/版本。
- 校准流程在后台 FreeRTOS 任务中运行，UI 实时显示 “保持静止”“8 字晃动” 等提示与百分比进度；校准完成后写入 NVS。

---

## UI 规范（240×320）
- **状态栏（20 px）**：GPS 图标 + 卫星数（红=未定位，绿=定位），SD 卡图标，电池百分比与充电图标。
- **字体**：Small 8 px、Medium 12 px、Large 16 px、XL 24 px、超大数字 48–64 px。
- **间距**：小 5 px / 中 10 px / 大 15 px。
- **颜色**：主文字白、次文字灰、背景黑；记录中红色闪烁；警告橙色。

---

## GNSS 数据解析与时间同步
- **NMEA 支持**：解析 GSV/GSA，按 `$GPGSV`、`$GLGSV`、`$GAGSV`、`$BDGSV` 识别星座，记录仰角与方位角。
- **UBX/PMTK 并行配置**：所有刷新率、星座组合、动态模式等设置会同步下发 PMTK 与 UBX 命令，固件在串口上解析 ACK/NAK 并写入诊断日志。
- **CN0 着色**：>45 绿色、35–45 黄绿、25–35 黄色、<25 橙/红。
- **RTC 初始化**：首次启动使用固件编译时间；GNSS 获得有效时间后自动同步 RTC，并在屏幕中央显示 “时间已同步” 2 s。
- **配置确认**：向 GNSS 发送配置指令后必须等待 ACK/NACK，结果写入日志。

---

## 诊断与日志
1. **启动 0–5 s**：每秒输出一次自检，包含 GNSS 状态、IMU 线性加速度/重力、陀螺仪、磁力计、气压计、MCU/IMU/气压计/磁力计温度。
2. **运行阶段**：每 5 s 输出心跳日志。
3. **事件触发**：旋转编码器或按键触发 `diagnostics_trigger()`，立即输出事件及持续时间。

示例：
```
[DIAG][T=10325ms]
GNSS: OK, 12 sats, (22.5431,113.9421)
IMU: ACC(L:0.05,-0.02,0.12) GRAV(0.00,0.00,9.81)
GYR(0.3,-0.1,0.0)
MAG: (32.1,5.4,-42.0)
BARO: 1013.2hPa
TEMP: MCU=37.5°C, IMU=35.8°C, BARO=34.9°C, MAG=35°C
RESULT: OK
```
