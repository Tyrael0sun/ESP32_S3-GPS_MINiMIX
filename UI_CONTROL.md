# UI 操作逻辑设计

## 硬件输入
- **旋转编码器**: 左右旋转（计数正负值）
- **按键**: 
  - 短按 (~50ms)
  - 中按 (~500ms)
  - 长按 (~2000ms)
  - 双击

## 操作逻辑

### 全局导航
```
[主界面循环]
Bike Computer → GPS Logger → P-Box → GNSS Info → Settings → (循环)

操作:
- 旋转编码器: 左转(-1) = 上一界面，右转(+1) = 下一界面
- 短按: 确认/进入当前界面功能
- 长按: 进入/退出Settings界面
```

### 各界面具体操作

#### 1. Bike Computer（自行车码表）
**显示**: 速度、高度、距离、时间、录制状态

**操作**:
- 旋转编码器: 无功能（或可用于缩放字体大小）
- 短按: 切换到下一界面
- 中按: 开始/停止GPS记录
- 长按: 进入Settings

**状态指示**:
- 录制中: 红点闪烁

---

#### 2. GPS Logger（轨迹记录）
**显示**: 速度、轨迹图、距离、时间、录制状态

**操作**:
- 旋转编码器: 缩放轨迹图
- 短按: 切换到下一界面
- 中按: 开始/停止记录
- 长按: 进入Settings

**录制逻辑**:
- 未录制状态: 中按开始录制，创建新文件
- 录制中: 中按停止录制，保存文件
- 录制中切换界面: 继续后台记录

---

#### 3. P-Box（性能测试）
**显示**: 当前速度、计时器、目标速度、最佳成绩

**操作**:
- 旋转编码器: 调整目标速度 (0-60, 0-100, 0-200 km/h)
- 短按: 切换到下一界面
- 中按: 开始/停止测试
- 长按: 进入Settings

**测试逻辑**:
- 检测到速度 > 5 km/h 自动开始计时
- 达到目标速度自动停止计时
- 显示用时并保存最佳成绩

---

#### 4. GNSS Info（GPS信息）
**显示**: 位置、精度、卫星列表

**操作**:
- 旋转编码器: 滚动卫星列表
- 短按: 切换到下一界面
- 中按: 刷新卫星信息
- 长按: 进入Settings

**卫星列表**:
- 颜色编码: 绿色=已用, 黄色=跟踪, 灰色=搜索
- 显示: ID, 星座, CN0信号强度, 状态

---

#### 5. Settings（设置菜单）
**显示**: 菜单列表（可滚动）

**菜单项**:
1. IMU Calibration - IMU校准
2. Mag Calibration - 磁力计校准
3. GNSS Rate - GPS更新率 (1/5/10 Hz)
4. GNSS Constellation - 星座选择 (GPS/GLONASS/Galileo/BeiDou)
5. Display Brightness - 屏幕亮度 (0-100%)
6. System Info - 系统信息 (版本、内存、SD卡)
7. Factory Reset - 恢复出厂设置

**操作**:
- 旋转编码器: 上下滚动菜单
- 短按: 选择当前菜单项
- 中按: 返回上一界面
- 长按: 退出Settings，返回Bike Computer

**子菜单操作**:
- IMU/Mag Calibration:
  - 短按: 开始校准
  - 校准过程中显示进度条
  - 完成后自动返回菜单
  
- GNSS Rate:
  - 旋转编码器: 选择 1/5/10 Hz
  - 短按: 确认
  
- GNSS Constellation:
  - 旋转编码器: 选择星座组合
  - 短按: 切换启用/禁用
  
- Display Brightness:
  - 旋转编码器: 调整 0-100%
  - 短按: 确认
  
- System Info:
  - 显示版本、RAM、Flash、SD卡信息
  - 短按: 返回菜单

- Factory Reset:
  - 短按: 显示确认对话框
  - 旋转编码器: 选择 Yes/No
  - 短按: 确认选择

---

## 状态指示

### 状态栏（所有界面共享，20px高度）
- **左侧**: GPS图标 + 卫星数量
  - 无定位: 灰色图标
  - 2D定位: 黄色图标  
  - 3D定位: 绿色图标
  
- **中间**: SD卡图标
  - 无卡: 灰色
  - 正常: 白色
  - 错误: 红色
  
- **右侧**: 电池图标 + 百分比
  - 充电中: 闪电图标
  - >60%: 绿色
  - 30-60%: 黄色
  - <30%: 红色

---

## 反馈机制

### 视觉反馈
1. 界面切换: 淡入淡出动画（可选）
2. 按键响应: 选中项高亮
3. 编码器旋转: 实时更新选项
4. 错误提示: 红色文字或图标闪烁

### 日志输出
- 所有按键事件打印LOG
- 编码器旋转打印计数值
- 界面切换打印目标界面

---

## 电源管理

### 休眠逻辑
- 60秒无操作: 降低屏幕亮度至20%
- 120秒无操作: 关闭屏幕（保持系统运行）
- GPS记录中: 不休眠

### 唤醒
- 任意按键或旋转编码器: 唤醒屏幕

---

## 数据保存

### 自动保存
- GPS轨迹: 每10秒写入SD卡
- 设置: 每次更改立即保存到NVS
- 最佳成绩: 测试完成后保存

### 文件格式
- GPS轨迹: `/gps_logs/YYYYMMDD_HHMMSS.gpx`
- 系统日志: `/logs/system.log`
- 配置文件: NVS分区

---

## 实现优先级

### Phase 1 - 基础导航 ✓
- [x] 旋转编码器切换界面
- [x] 短按确认
- [x] 长按进入/退出Settings

### Phase 2 - 功能实现
- [ ] GPS Logger 开始/停止记录
- [ ] P-Box 性能测试逻辑
- [ ] GNSS Info 列表滚动
- [ ] Settings 菜单交互

### Phase 3 - 优化
- [ ] 动画效果
- [ ] 休眠/唤醒
- [ ] 错误处理
- [ ] 数据持久化

