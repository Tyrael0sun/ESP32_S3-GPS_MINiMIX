# ESP32-S3 多功能GPS性能分析设备

## 软件需求规格说明书（SRS）v2.2

-----

## 1\. 项目目标

本项目旨在基于 `ESP32-S3FH4R2` 微控制器，从零开始打造一款多功能、高性能的GPS性能分析设备。该设备集成了**自行车码表**、**GPS轨迹记录仪**和\*\*汽车性能测试盒（P-Box）\*\*三大核心功能，旨在为骑行和驾驶爱好者提供精确、丰富的实时数据和性能分析工具。

**关键器件:**

  * **主控芯片:** `ESP32-S3FH4R2`
  * **GNSS:** `MAX-F10S` / `ATGM336H`
  * **传感器:** `LSM6DSR` (`0xD5`)X，Z轴反向，Y不变、`LIS2MDL` (`0x3D`)X，Y轴交换后Y轴反向，Z轴反向、`BMP388` (`0xED`)
  * **传感器:** 驱动芯片`ST7789`，分辨率为长320\*宽240，显示旋转180°

-----

## 2\. 核心功能实现

我们成功实现了所有预定目标，最终交付的固件包含以下关键功能：

  * **多模应用系统:**

      * **自行车码表模式:** 实时显示速度、海拔、累计里程、坡度等关键骑行数据。
      * **汽车P-Box模式:** 用于性能测试，如0-100km/h加速,通过传感器融合（IMU加速度+GPS速度）实现精确的自动启停计时。
      * **GPS轨迹记录:** 用于记录骑行或徒步时的GPS轨迹，记录时显示GPS信息、速度信息、海拔、累计里程、气压信息、地磁方向信息。
      * **GNSS信息显示:** 专业GNSS诊断界面，显示定位信息、精度（HDOP/VDOP/PDOP）、卫星列表（包含卫星编号、类型、CN0值、状态）。

  * **高级用户界面 (UI):**

      * 基于 `LVGL` 图形库构建，界面美观、流畅，并支持多屏幕切换。
      * 包含一个常驻的状态栏，实时显示GPS信号、SD卡状态、电池电量及充电状态。

  * **GPS轨迹记录:**

      * 通过长按按键控制记录的开始与停止。
      * 以标准的 GPX 格式将轨迹数据保存到SD卡，兼容各大运动平台。
      * GPX文件中通过扩展标签额外记录了温度、G值等丰富数据。

  * **完整的硬件驱动:**

      * 为所有外设（`ST7789`显示屏、`LSM6DSR`、`LIS2MDL`、`BMP388`传感器、GPS模块、SDIO卡槽、旋转编码器）编写了稳定、模块化的驱动。

  * **传感器校准:**

      * 实现了加速度计和磁力计的运行时校准功能。
      * 校准数据被永久保存在ESP32的 **NVS（非易失性存储）** 中，设备重启后自动加载。

  * **详细的诊断日志:**

      * 实现了专业的启动日志系统，在设备启动的前5秒内详细报告所有硬件的连接状态和关键读数，之后切换为低频心跳日志。
      * 输出内容包含三传感器温度（MCU/IMU/气压计）、IMU线性加速度和重力分量。

-----

## 3\. 技术架构

  * **开发环境:** ESP-IDF
  * **核心框架:** FreeRTOS `ESP32-S3FH4R2`
  * **UI:** `LVGL` (图形库) + `LovyanGFX` (显示驱动)
  * **核心组件:**
      * **显示:** 通过高速SPI驱动 `ST7789` LCD (240×320分辨率，竖屏模式，旋转180°)。
      * **存储:** 通过4-bit SDIO模式高速读写SD卡。
      * **输入:** 通过GPIO中断精确捕捉按键事件。通过PCNT捕获旋转编码器的旋转（带500ms消抖机制）。
  * **代码结构:**
      * 采用了高度模块化的设计，将硬件驱动、UI和应用逻辑完全解耦，并通过中央 `config.h` 和 `ui_common.h` 文件管理所有硬件和UI定义，具有极佳的可维护性和可移植性。
      * 所有UI界面统一适配240×320分辨率，详见 `docs/UI_LAYOUT_240x320.md`。

-----

## 4\. 最终交付

  * 整合的烧录文件作为release发布，初始版本为 `V0.0.1`

-----

## 5\. 软件需求规格说明书 (SRS) v2.2

### 5.1 硬件接口定义 (GPIO配置表)

| 功能模块 | 引脚名称 | GPIO | 备注 |
| :--- | :--- | :--- | :--- |
| 调试 | `DEBUG_TX` | `GPIO43` | UART0, 115200bps |
| 调试 | `DEBUG_RX` | `GPIO44` | UART0, 115200bps |
| 显示 | `DISP_SCK` | `GPIO5` | SPI3 |
| | `DISP_MOSI` | `GPIO8` | SPI3 |
| | `DISP_CS` | `GPIO7` | SPI3 |
| | `DISP_DC` | `GPIO6` | SPI3 |
| | `DISP_RST` | `GPIO4` | SPI3 |
| | `DISP_BL` | `GPIO9` | LEDC Backlight 2K PWM 默认占空比50% |
| GNSS | `GNSS_TX` | `GPIO17` | UART1, 115200bps |
| | `GNSS_RX` | `GPIO18` | UART1 |
| | `GPS_LDO_EN` | `GPIO14` | 高电平使能 |
| I2C 总线 1Mhz | `I2C_SCL` | `GPIO39` | I2C\_NUM\_0 |
| | `I2C_SDA` | `GPIO40` | I2C\_NUM\_0 |
| 传感器中断 | `ACCGYRO_INT` | `GPIO41` | 未使用 |
| | `MAG_INT` | `GPIO42` | 未使用 |
| | `PRESS_INT` | `GPIO13` | 未使用 |
| SD卡 | `SD_D1` | `GPIO38` | SDIO 4-bit |
| | `SD_D0` | `GPIO37` | SDIO 4-bit |
| | `SD_CLK` | `GPIO36` | SDIO 4-bit |
| | `SD_CMD` | `GPIO35` | SDIO 4-bit |
| | `SD_D2` | `GPIO34` | SDIO 4-bit |
| | `SD_D3` | `GPIO33` | SDIO 4-bit |
| 输入 | `ENC_A` | `GPIO1` | 旋转编码器 A相 输入上拉 |
| | `ENC_B` | `GPIO3` | 旋转编码器 B相 输入上拉 |
| | `KEY_MAIN` | `GPIO2` | 主功能按键 输入上拉 |
| 电源管理 | `BAT_ADC` | `GPIO12` | ADC2\_CH1 外部为电池电压1：1分压|
| | `CHRG_STATUS` | `GPIO21` | 充电状态输入 输入上拉 |

-----

### 5.2 功能需求

#### 核心功能 (CORE)

  * **F-CORE-01:** 系统应提供自行车码表、GPS轨迹记录仪、汽车性能测试盒、GNSS信息显示四大独立的功能模块。
  * **F-CORE-02:** 在自行车码表模式下，用户应能通过输入操作调用GPS轨迹记录功能。
  * **F-CORE-03:** 系统应提供一个独立的设置界面模块，用于配置系统级参数。
  * **F-CORE-04:** 系统应提供GNSS信息显示界面，用于专业诊断和卫星状态监控。

#### 系统与时间 (SYS)

  * **F-SYS-01:** 系统首次启动时，RTC（实时时钟）的初始时间应被设置为固件的编译时间。
  * **F-SYS-02:** 当GNSS模块获取到有效的卫星时间后，系统应自动将RTC时间与GNSS时间同步。
  * **F-SYS-03:** RTC时间同步成功完成后，屏幕中央应显示“时间已同步”提示信息，持续2秒。
  * \***F-SYS-04:** 在向GNSS模块发送配置命令后（如修改刷新率），系统必须等待并解析模块返回的ACK/NACK响应，以确认配置是否成功，并将结果记录到日志中。

#### 用户界面 (UI)

  * **F-UI-01:** 系统的所有用户界面应基于 `LVGL` 图形库构建。
  * **F-UI-02:** 所有主功能界面（码表、P-Box、轨迹记录）的顶部应共享一个统一的状态栏。
  * **F-UI-03 (已更新):** 状态栏应实时显示以下信息：GNSS锁定卫星数量（**定位成功前显示为红色，定位成功后显示为绿色**）、SD卡状态（是否存在）、电池电量百分比、充电状态图标。
  * \***F-UI-04:** 为提高代码可维护性，每个主功能界面的UI代码应被组织在独立的源文件中（例如 `ui_bike_computer.cpp`, `ui_pbox.cpp`）。

#### 用户输入 (INPUT)

  * **F-INPUT-01:** 系统应能精确响应旋转编码器的旋转、短按、中按、长按、双击五种事件。
  * **F-INPUT-02:** 在主功能界面之间切换的操作定义为：短按切换模式（自行车码表→GPS轨迹记录→P-Box→GNSS信息→自行车码表），中按启动/停止轨迹记录，长按进入设置界面。
  * **F-INPUT-03:** 按键事件的时间定义为：消抖时间100ms，短按持续时间小于1秒，中按持续时间在1秒至3秒之间，长按持续时间大于3秒。
  * **F-INPUT-04:** 旋转编码器计数应在500ms无变化时自动清零，防止机械振动导致的计数漂移。

#### 自行车码表 (BC)

  * **F-BC-01:** 自行车码表界面必须实时显示以下核心数据：当前速度（km/h）、海拔高度（m）、本次骑行累计里程（km）、本次骑行时间(hh:mm:ss)、开始记录轨迹按钮（开始记录为红色闪烁方块，未记录为绿色圆圈）。

#### GPS轨迹记录 (LOG)

  * **F-LOG-01:** GPS轨迹记录功能应将轨迹数据以GPX格式写入SD卡的 `/GPX/` 目录中。GPX文件必须支持包含温度、G值等数据的扩展标签。
  * **F-LOG-02:** GPS轨迹记录界面必须实时显示以下核心数据：当前速度（km/h）、海拔高度（m）、本次轨迹里程（km）、本次轨迹时间(hh:mm:ss)、开始记录轨迹按钮（开始记录为红色闪烁方块，未记录为绿色圆圈）。

#### 汽车性能测试盒 (PBOX)

  * **F-PBOX-01:** 汽车性能测试盒模式应提供0-100km/h的加速测试功能。（测试起始速度，终止速度可调）
  * **F-PBOX-02:** 加速计时的自动启动条件定义为：当前GPS速度小于1km/h，且车辆纵向（前进方向）的线性加速度超过0.15G。
  * **F-PBOX-03:** 加速计时界面必须显示当前速度（km/h）、测试时间（分:秒:毫秒）测试结束时显示大字体TEST FINISHED!!!

#### GNSS信息显示 (GNSS)

  * **F-GNSS-01:** GNSS信息界面应分为三部分显示：定位信息、精度信息、卫星列表。
  * **F-GNSS-02:** 定位信息必须显示：经度、纬度、高度、速度。
  * **F-GNSS-03:** 精度信息必须显示：HDOP（水平精度因子）、VDOP（垂直精度因子）、PDOP（位置精度因子）。
  * **F-GNSS-04:** 卫星列表必须显示每颗卫星的：卫星编号、星座类型（GPS/GLONASS/Galileo/BeiDou）、CN0信号强度（dBHz）、当前状态（搜索/跟踪/使用）。
  * **F-GNSS-05:** 卫星列表应支持滚动显示，当卫星数量超过可见区域时。
  * **F-GNSS-06:** 卫星状态应使用颜色区分：搜索（灰色）、跟踪（黄色）、使用（绿色）。

#### 设置与校准 (SET)

  * **F-SET-01:** 设置界面必须提供一个引导流程，用于执行IMU（加速度计和磁力计）的运行时校准。
  * **F-SET-02:** 设置界面应允许用户配置GNSS模块的刷新率，可选值为：1Hz, 5Hz, 10Hz, 25Hz。
  * **F-SET-03:** 设置界面应允许用户配置GNSS模块要使用的卫星星座组合。
  * **F-SET-04:** 传感器校准过程应在一个独立的后台任务（FreeRTOS Task）中执行，以避免阻塞UI线程，并在校准期间向用户显示等待状态。
  * **F-SET-05:** 设置界面应提供独立的 **“IMU校准”** 选项，用于引导用户执行加速度计和陀螺仪的校准流程（例如，将设备保持多面静止）。
  * **F-SET-06:** 设置界面应提供独立的 **“地磁校准”** 选项，用于引导用户执行磁力计的校准流程（例如，在空中进行8字晃动以采集数据）。

#### 配置与维护 (CONF)

  * \***F-CONF-01:** 系统中的关键阈值（如P-Box启动加速度0.15G、按键时长定义等）不应硬编码在代码中，而应统一在 `config.h` 文件中定义，或通过设置菜单进行配置，以提高可配置性。

#### 诊断与日志 (DIAG)

  * **F-DIAG-01:** 设备启动后的前5秒内，应以高频（例如每秒一次）输出硬件自检状态到串口。
  * **F-DIAG-02:** 自检报告必须包含以下模块的状态和关键读数：GNSS模块、IMU（线性加速度和重力分量）、磁力计、气压计，以及四个来源的温度读数（MCU内部/IMU/气压计/磁力计）。
  * **F-DIAG-03:** 当旋转编码器转动时和按键按下时立即上报状态。

-----

### 5.3 系统诊断与日志

#### 输出示例（串口）

```log
[DIAG][T=10325ms]
GNSS: OK, 12 sats, (22.5431,113.9421)
IMU: ACC(L:0.05,-0.02,0.12) GRAV(0.00,0.00,9.81)
GYR(0.3,-0.1,0.0)
MAG: (32.1,5.4,-42.0)
BARO: 1013.2hPa
TEMP: MCU=37.5°C, IMU=35.8°C, BARO=34.9°C, MAG=35°C
RESULT: OK
```

---

## 6\. UI界面设计规范 (240×320分辨率)

### 6.1 通用UI规范

所有UI界面统一适配240×320像素竖屏显示，定义在`main/ui/ui_common.h`：

**屏幕规格**:
- 分辨率: 240px (宽) × 320px (高)
- 方向: 竖屏 (Portrait)
- 旋转: 180° (DISP_ROTATION = 2)

**通用布局**:
- 状态栏: 20px (顶部固定)
- 内容区: 300px (各界面自定义)

**字体大小**:
- SMALL: 8px (状态栏、小标签)
- MEDIUM: 12px (标签、说明文字)
- LARGE: 16px (数据显示)
- XLARGE: 24px (大标题)
- 超大数字: 48-64px (速度、计时器)

**间距规范**:
- 小间距: 5px (元素内部)
- 中间距: 10px (元素之间)
- 大间距: 15px (区块之间)

**颜色方案**:
- GPS无定位: 红色 (0xFF0000)
- GPS已定位: 绿色 (0x00FF00)
- 记录中: 红色闪烁
- 警告: 橙色 (0xFFA500)
- 主文字: 白色 (0xFFFFFF)
- 次文字: 灰色 (0x808080)
- 背景: 黑色 (0x000000)

### 6.2 各界面布局详解

#### 6.2.1 状态栏 (20px)

**布局** (从左到右):
```
[GPS图标(30px)] [卫星数(40px)] [SD卡(30px)] [空白(40px)] [电池(70px)] [充电(30px)]
```

**显示元素**:
- GPS图标: 红色=无定位, 绿色=已定位
- 卫星数: 显示可见卫星数量
- SD卡: 灰色=无卡, 白色=已插入
- 电池: 电量百分比 + 电量条
- 充电: 闪电图标 (充电中)

#### 6.2.2 自行车码表 (MODE_BIKE_COMPUTER)

**布局结构** (总计320px):
```
┌─────────────────────────┐
│ 状态栏 (20px)          │
├─────────────────────────┤
│   速度显示 (120px)     │  ← 48px字体
│   "45.3 km/h"          │
├─────────────────────────┤
│ 高度: 125.5m (45px)    │  ← 16px数据
├─────────────────────────┤
│ 距离: 12.3km (45px)    │
├─────────────────────────┤
│ 时间: 01:23:45 (45px)  │
├─────────────────────────┤
│ [REC] 记录中 (45px)    │  ← 红色闪烁/绿色
└─────────────────────────┘
```

#### 6.2.3 GPS记录器 (MODE_GPS_LOGGER)

**布局结构** (总计320px):
```
┌─────────────────────────┐
│ 状态栏 (20px)          │
├─────────────────────────┤
│ 当前速度: 35.2 (100px) │
├─────────────────────────┤
│   GPS轨迹图 (120px)    │  ← 可视化轨迹
├─────────────────────────┤
│ 距离: 8.5km (40px)     │
├─────────────────────────┤
│ 时间: 00:45:30 (40px)  │
└─────────────────────────┘
```

#### 6.2.4 P-Box性能测试 (MODE_PBOX)

**布局结构** (总计320px):
```
┌─────────────────────────┐
│ 状态栏 (20px)          │
├─────────────────────────┤
│   当前速度 (140px)     │  ← 64px字体
│     "78.5 km/h"        │
├─────────────────────────┤
│   测试时间 (80px)      │  ← 32px字体
│   "05.234 s"           │
├─────────────────────────┤
│ 目标: 0→100km/h (40px) │
├─────────────────────────┤
│ [状态提示] (40px)      │  ← 准备/测试中/完成
└─────────────────────────┘
```

#### 6.2.5 GNSS信息 (MODE_GNSS_INFO)

**布局结构** (总计320px):
```
┌─────────────────────────┐
│ 状态栏 (20px)          │
├─────────────────────────┤
│ Lat: 22.54321°         │
│ Lon: 113.94210° (60px) │  ← 定位信息
│ Alt: 125m Spd: 45km/h  │
├─────────────────────────┤
│ HDOP:1.2 VDOP:1.5 (40px)│  ← 精度信息
├─────────────────────────┤
│ ID  TYPE  CN0  STATUS  │  ← 表头
│ 001  GPS   45   USE    │
│ 002  GPS   42   USE    │
│ ...  (可滚动) (200px)  │  ← 卫星列表
└─────────────────────────┘
```

**卫星列表特点**:
- 行高: 20px
- 可见: 10行
- 滚动: >10颗卫星时
- 颜色: SRCH(灰)/TRK(黄)/USE(绿)

#### 6.2.6 设置菜单 (MODE_SETTINGS)

**布局结构** (总计300px + 20px缓冲):
```
┌─────────────────────────┐
│ 状态栏 (20px)          │
├─────────────────────────┤
│ > IMU校准 (40px)       │  ← 选中项
├─────────────────────────┤
│   磁力计校准 (40px)    │
├─────────────────────────┤
│   GNSS频率 (40px)      │
├─────────────────────────┤
│   星座选择 (40px)      │
├─────────────────────────┤
│   显示亮度 (40px)      │
├─────────────────────────┤
│   关于/版本 (40px)     │
├─────────────────────────┤
│   [可滚动...] (60px)   │
└─────────────────────────┘
```

### 6.3 GNSS卫星信息扩展

**新增数据结构**:
- 卫星编号 (sat_id)
- 星座类型 (GPS/GLONASS/Galileo/BeiDou)
- 信号强度 CN0 (dBHz)
- 卫星状态 (SEARCHING/TRACKING/USED)
- 仰角和方位角

**NMEA句子解析**:
- GSV: 卫星视图 (ID, 仰角, 方位, CN0)
- GSA: DOP和活跃卫星 (PDOP, HDOP, VDOP)

**多星座识别**:
- $GPGSV → GPS
- $GLGSV → GLONASS
- $GAGSV → Galileo
- $BDGSV → BeiDou

**颜色编码**:
- 搜索中: 灰色 (0x808080)
- 跟踪中: 黄色 (0xFFFF00)
- 使用中: 绿色 (0x00FF00)
- CN0 > 45: 优秀 (绿)
- CN0 35-45: 良好 (黄绿)
- CN0 25-35: 中等 (黄)
- CN0 < 25: 较弱 (橙/红)

